# AST ç±»å‹æç¤º - æœ€ç»ˆå®ç°æ€»ç»“

## ğŸ‰ åŠŸèƒ½çŠ¶æ€ï¼šå·²å®Œæˆ

ç‰ˆæœ¬ï¼šv1.4.0  
å®Œæˆæ—¶é—´ï¼š2025-11-23

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒèƒ½åŠ›
1. **æ™ºèƒ½ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šä½¿ç”¨ CodeMirror Lezer è¯­æ³•æ ‘è¿›è¡Œç²¾ç¡®çš„ä¸Šä¸‹æ–‡åˆ†æ
2. **å­—æ®µåè¡¥å…¨**ï¼šæ ¹æ®å½“å‰ Element çš„ `type` åŠ¨æ€æä¾›å­—æ®µåå»ºè®®
3. **å€¼è¡¥å…¨**ï¼šä¸º `type` å­—æ®µæä¾›æ‰€æœ‰ 21 ç§ Element ç±»å‹çš„æšä¸¾å€¼
4. **é…ç½®åŒ–**ï¼šå¯åœ¨è®¾ç½®é¡µé¢å¼€å¯/å…³é—­æ­¤åŠŸèƒ½ï¼ˆé»˜è®¤å¼€å¯ï¼‰
5. **æ™ºèƒ½è§¦å‘**ï¼šé¿å…åœ¨è¾“å…¥é€—å·åç«‹å³è§¦å‘ï¼Œä¸å¹²æ‰°æ¢è¡Œæ“ä½œ

### æ”¯æŒçš„ Element ç±»å‹ï¼ˆ21ç§ï¼‰
- paragraph, head, card, image, code, blockquote
- list-item, table, table-row, table-cell
- link, mention, inline-code, inline-card
- badge, time, avatar, media
- text, container, line

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ä¸Šä¸‹æ–‡åˆ†æ (context-analyzer.ts)

#### å…³é”®ä¿®å¤
- **å†’å·èŠ‚ç‚¹åç§°**ï¼šCodeMirror ä¸­å†’å·èŠ‚ç‚¹æ˜¯ `':'` è€Œä¸æ˜¯ `'Colon'`
- **AST éå†ä¼˜å…ˆçº§**ï¼šä½¿ç”¨ `foundContext` æ ‡å¿—é¿å…åç»­èŠ‚ç‚¹è¦†ç›–å·²è¯†åˆ«çš„ä¸Šä¸‹æ–‡
- **String èŠ‚ç‚¹åˆ¤æ–­**ï¼šé€šè¿‡æ£€æŸ¥ String èŠ‚ç‚¹ä¸å†’å·çš„ä½ç½®å…³ç³»ï¼ŒåŒºåˆ†å±æ€§åå’Œå±æ€§å€¼
- **çº¯æ–‡æœ¬åˆ†æ**ï¼šå½“ AST è§£æå¤±è´¥æ—¶ä½¿ç”¨çº¯æ–‡æœ¬åˆ†æä½œä¸ºé™çº§æ–¹æ¡ˆ

```typescript
// æ ¸å¿ƒé€»è¾‘
const colonNode = parent.getChild(':')  // âœ… æ­£ç¡®çš„èŠ‚ç‚¹åç§°
if (colonNode && currentNode.from > colonNode.to) {
  // åœ¨å†’å·ä¹‹å â†’ å±æ€§å€¼
  result.type = ContextType.PropertyValue
  result.propertyNameForValue = extractPropertyName(...)
} else {
  // åœ¨å†’å·ä¹‹å‰ â†’ å±æ€§å
  result.type = ContextType.PropertyName
}
```

### 2. è¡¥å…¨é€»è¾‘ (completion-source.ts)

#### ä½ç½®è®¡ç®—
```typescript
// å…³é”®ï¼šfrom å¿…é¡»æŒ‡å‘å¯è¾“å…¥ä½ç½®ï¼ˆå¼•å·å†…ï¼‰
let from = pos
if (inQuote) {
  // æ‰¾åˆ°å·¦å¼•å·ï¼Œfrom = å¼•å·ä½ç½® + 1
  for (let i = pos - 1; i >= 0; i--) {
    if (char === '"') {
      from = i + 1  // âœ… ä»å¼•å·åå¼€å§‹
      break
    }
  }
}
```

#### æ™ºèƒ½è§¦å‘
```typescript
// é¿å…åœ¨é€—å·åç«‹å³è§¦å‘ï¼Œä¸å¹²æ‰°æ¢è¡Œ
if (!explicit && pos > 0) {
  const charBefore = state.doc.sliceString(pos - 1, pos)
  if (charBefore === ',' || charBefore === '\n') {
    return null
  }
}
```

### 3. æ ·å¼å®šåˆ¶ (codemirror.styles.ts)

- ç™½è‰²èƒŒæ™¯ï¼Œæ¸…æ™°çš„è¾¹æ¡†å’Œé˜´å½±
- è“è‰²é€‰ä¸­é«˜äº® (#0066ff)
- Emoji å›¾æ ‡åŒºåˆ†ç±»å‹
- æ¸…æ™°çš„ä¿¡æ¯é¢æ¿

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè¾“å…¥ type å€¼
```json
{
  "type": "|"
}
```
**è¡¥å…¨æç¤º**ï¼šparagraph, head, card, image...

### åœºæ™¯ 2ï¼šè¾“å…¥å­—æ®µå
```json
{
  "type": "paragraph",
  "|"
}
```
**è¡¥å…¨æç¤º**ï¼šchildren, id, align, indent...

### åœºæ™¯ 3ï¼šæ ¹æ® type æç¤ºç‰¹å®šå­—æ®µ
```json
{
  "type": "card",
  "|"
}
```
**è¡¥å…¨æç¤º**ï¼šchildren, title, description, avatar...

## âš™ï¸ é…ç½®

### å¼€å¯/å…³é—­
1. æ‰“å¼€è®¾ç½®é¡µé¢
2. æ‰¾åˆ°"åŠŸèƒ½é¡¹é…ç½®"
3. åˆ‡æ¢"ASTç±»å‹æç¤º"å¼€å…³

### å¿«æ·é”®
| æ“ä½œ | Mac | Windows/Linux |
|------|-----|---------------|
| æ‰‹åŠ¨è§¦å‘è¡¥å…¨ | `Cmd+.` | `Ctrl+.` |
| å¤‡ç”¨å¿«æ·é”® | `Alt+/` | `Alt+/` |
| æ¥å—è¡¥å…¨ | `Tab` / `Enter` | `Tab` / `Enter` |
| å–æ¶ˆè¡¥å…¨ | `Esc` | `Esc` |

## ğŸ› å·²è§£å†³çš„é—®é¢˜

### é—®é¢˜ 1ï¼šå†’å·èŠ‚ç‚¹æ‰¾ä¸åˆ°
**åŸå› **ï¼šè¯¯ä»¥ä¸ºèŠ‚ç‚¹åæ˜¯ `'Colon'`ï¼Œå®é™…æ˜¯ `':'`  
**è§£å†³**ï¼šæ›´æ­£æ‰€æœ‰ `getChild('Colon')` ä¸º `getChild(':')`

### é—®é¢˜ 2ï¼šArray èŠ‚ç‚¹è¦†ç›– PropertyValue
**åŸå› **ï¼šAST éå†è¿‡ç¨‹ä¸­åç»­èŠ‚ç‚¹è¦†ç›–äº†å·²è¯†åˆ«çš„ä¸Šä¸‹æ–‡  
**è§£å†³**ï¼šæ·»åŠ  `foundContext` æ ‡å¿—ï¼Œåªåœ¨æœªæ‰¾åˆ°ä¸Šä¸‹æ–‡æ—¶æ‰ç»§ç»­è¯†åˆ«

### é—®é¢˜ 3ï¼šfrom ä½ç½®ä¸å¯¹
**åŸå› **ï¼š`from` æŒ‡å‘å¼•å·ä½ç½®(18)ï¼Œä½†å…‰æ ‡åœ¨å¼•å·å†…(19)  
**è§£å†³**ï¼šè®¡ç®—æ—¶ç¡®ä¿ `from` æŒ‡å‘å¼•å·åçš„ä½ç½®ï¼ˆå¼•å·ä½ç½®+1ï¼‰

### é—®é¢˜ 4ï¼šè¾“å…¥é€—å·å Enter ä¸èƒ½æ¢è¡Œ
**åŸå› **ï¼šè‡ªåŠ¨è§¦å‘è¡¥å…¨åï¼ŒEnter é”®è§¦å‘è¡¥å…¨è€Œä¸æ˜¯æ¢è¡Œ  
**è§£å†³**ï¼šæ£€æµ‹å…‰æ ‡å‰å­—ç¬¦ï¼Œå¦‚æœæ˜¯é€—å·æˆ–æ¢è¡Œåˆ™ä¸è‡ªåŠ¨è§¦å‘

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **è§¦å‘å»¶è¿Ÿ**ï¼š50ms
- **æ›´æ–°åŒæ­¥**ï¼š50ms
- **æœ€å¤§é€‰é¡¹æ•°**ï¼š20
- **æ”¯æŒæ–‡æ¡£å¤§å°**ï¼šæ— é™åˆ¶ï¼ˆä½¿ç”¨é™çº§ç­–ç•¥ï¼‰

## ğŸ”® æœªæ¥å¢å¼º

### v1.5.0+
- [ ] **children å†…éƒ¨ç±»å‹æç¤º**ï¼šæ ¹æ®çˆ¶ Element çš„ `children` å­—æ®µå®šä¹‰ï¼Œæä¾›å­å…ƒç´ çš„ç±»å‹æç¤º
- [ ] **æšä¸¾å€¼è¡¥å…¨**ï¼šä¸ºå…¶ä»–æšä¸¾ç±»å‹å­—æ®µï¼ˆå¦‚ align, sizeï¼‰æä¾›å€¼è¡¥å…¨
- [ ] **ç±»å‹æ¨å¯¼**ï¼šæ ¹æ®å·²è¾“å…¥çš„å­—æ®µæ¨å¯¼å¯èƒ½çš„ Element ç±»å‹
- [ ] **ä»£ç ç‰‡æ®µ**ï¼šæä¾›å¸¸ç”¨ Element ç»“æ„çš„å¿«é€Ÿæ¨¡æ¿

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒå®ç°
- `src/features/schema-drawer/utils/ast-completion/context-analyzer.ts` - ä¸Šä¸‹æ–‡åˆ†æ
- `src/features/schema-drawer/utils/ast-completion/completion-source.ts` - è¡¥å…¨é€»è¾‘
- `src/features/schema-drawer/utils/ast-completion/element-fields.ts` - å­—æ®µå®šä¹‰

### UI å’Œé…ç½®
- `src/features/schema-drawer/components/CodeMirrorEditor.tsx` - ç¼–è¾‘å™¨é›†æˆ
- `src/features/schema-drawer/styles/codemirror.styles.ts` - UI æ ·å¼
- `src/features/options-page/OptionsApp.tsx` - é…ç½®é¡µé¢

### ç±»å‹å®šä¹‰
- `src/shared/types/index.ts` - StorageData æ¥å£
- `src/shared/constants/defaults.ts` - é»˜è®¤å€¼
- `src/shared/utils/browser/storage.ts` - å­˜å‚¨ç®¡ç†

## ğŸ“ ç»éªŒæ€»ç»“

1. **æ·±å…¥ç†è§£æ¡†æ¶å†…éƒ¨**ï¼šCodeMirror çš„èŠ‚ç‚¹å‘½åä¸ä¸€å®šç¬¦åˆç›´è§‰ï¼Œéœ€è¦å®é™…è°ƒè¯•
2. **çŠ¶æ€ç®¡ç†å¾ˆé‡è¦**ï¼šä½¿ç”¨æ ‡å¿—ä½é¿å…é‡å¤å¤„ç†å’Œè¦†ç›–
3. **ä½ç½®è®¡ç®—è¦ç²¾ç¡®**ï¼šè¡¥å…¨çš„ `from` ä½ç½®å¿…é¡»ç²¾ç¡®åˆ°å¯è¾“å…¥ä½ç½®
4. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šé¿å…åœ¨ä¸åˆé€‚çš„æ—¶æœºè§¦å‘è¡¥å…¨
5. **é™çº§ç­–ç•¥**ï¼šAST è§£æå¤±è´¥æ—¶ä½¿ç”¨çº¯æ–‡æœ¬åˆ†æä½œä¸ºå¤‡é€‰

## âœ… éªŒæ”¶æ ‡å‡†

- [x] åœ¨ `"type": ""` å†…æä¾› 21 ç§ç±»å‹è¡¥å…¨
- [x] æ ¹æ® Element ç±»å‹æä¾›ç‰¹å®šå­—æ®µè¡¥å…¨
- [x] æä¾›é€šç”¨å­—æ®µè¡¥å…¨ï¼ˆtype, children, idï¼‰
- [x] é…ç½®é¡µé¢å¯å¼€å¯/å…³é—­
- [x] è‡ªå®šä¹‰å¿«æ·é”®æ”¯æŒ
- [x] ä¸åœ¨é€—å·åç«‹å³è§¦å‘
- [x] UI æ¸…æ™°ç¾è§‚
- [x] 100% å‡†ç¡®çš„ä¸Šä¸‹æ–‡è¯†åˆ«

---

**çŠ¶æ€**ï¼šâœ… **ç”Ÿäº§å°±ç»ª**  
**ç‰ˆæœ¬**ï¼šv1.4.0  
**ç»´æŠ¤è€…**ï¼šAI Assistant  
**æœ€åæ›´æ–°**ï¼š2025-11-23

